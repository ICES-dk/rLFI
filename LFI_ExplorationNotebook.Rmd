---
title: "LFI Exploration"
output: html_notebook
---
# DATRAS

The ultimate goal is to translate ICES DATRAS Survey data into swept area abundance, which can be converted into useful indices such as the Large Fish Index (LFI). To get to this point, biological and haul data will need to be processed and in some instances estimated. The first part of the script will clean up the haul data.


We will need a few packages to get the data and to wrangle it into a useful format. Note, we're using the "development" version of [icesDATRAS](https://github.com/ices-tools-prod/icesDatras/tree/development) because it should be a bit faster. 

```{r, echo=FALSE}
library(devtools)
install_github("ices-tools-prod/icesDatras@development", quiet = TRUE)
library(icesDatras)
library(tidyverse)
library(data.table)
```


## Haul Data
> "As crazy as hauling timber into the woods." - Horace

Haul data consists of parameters describing how the fishing went - tow length, gear dimensions, and speed. These values can be manipulated to calculate the area fished (gear width * distance towed), so we can expore differences in abundance between years and areas. There are several surveys that we will need to use that have occured in different years and different quarters. Using the combination of survey year and quarters, we can query DATRAS.

```{r, warning=FALSE}
# List of surveys in DATRAS
surveyList <- getSurveyList()

# Get an overview of the surveys, years, and quarters
surveyExpanded <- data.frame()
for(i in 1:length(surveyList)) {
  tt <- getDatrasDataOverview(surveyList[i])[[1]]
  td <- data.frame(colnames(tt),
                   surveyList[i],
                   matrix(t(tt), ncol = 4),
                   stringsAsFactors = FALSE)
  colnames(td) <- c("YEAR", "SURVEY", paste0("Q", 1:4))
  
  tl <- td %>%
    gather(key = Quarter, value = value, -YEAR, -SURVEY) %>%
    filter(value != 0) %>%
    mutate(YEAR = as.numeric(YEAR),
           Quarter = as.numeric(gsub("Q", "", Quarter))) %>%
    select(-value)
  
surveyExpanded <- rbind(tl, surveyExpanded) 
}


hhdata <- rbindlist(
                  lapply(1:nrow(surveyExpanded),
                         function(x) {
                           return(getHHdata(survey = surveyExpanded$SURVEY[x],
                                            year = surveyExpanded$YEAR[x],
                                            quarter = surveyExpanded$Quarter[x]))
                         }
                  )
)
```



## Biological data

> "Fishing is boring, unless you catch an actual fish, and then it is disgusting" - Dave Barry

Now, we can download all of the biological data. This should be fun, last time I ran it, there were ```scales::comma(nrow(hldata))``` rows (probably takes 30 minutes to download)!

```{r}

hldata <- rbindlist( 
                  lapply(1:nrow(surveyExpanded),
                         function(x) {
                           return(getHLdata(survey = surveyExpanded$SURVEY[x],
                                            year = surveyExpanded$YEAR[x],
                                            quarter = surveyExpanded$Quarter[x]))
                         }
                  )
)
```


